<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="蓝牙,CoreBluetooth," />










<meta name="description" content="这篇文章讲的是苹果原生框架CoreBluetooth的使用。git上有个库BabyBluetooth 基于原生CoreBluetooth框架进行了封装，使用起来也很方便，大家可以尝试一下。  蓝牙常见名称和缩写 MFI ==== make for ipad ,iphone, itouch 专为苹果设备制作的设备  BLE ==== buletouch low energy，蓝牙4.0设备因为低耗电">
<meta name="keywords" content="蓝牙,CoreBluetooth">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS蓝牙4.0开发之CoreBluetooth框架">
<meta property="og:url" content="http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/index.html">
<meta property="og:site_name" content="兮兮_sunshine">
<meta property="og:description" content="这篇文章讲的是苹果原生框架CoreBluetooth的使用。git上有个库BabyBluetooth 基于原生CoreBluetooth框架进行了封装，使用起来也很方便，大家可以尝试一下。  蓝牙常见名称和缩写 MFI ==== make for ipad ,iphone, itouch 专为苹果设备制作的设备  BLE ==== buletouch low energy，蓝牙4.0设备因为低耗电">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/CoreBluetoothFramework.jpeg">
<meta property="og:image" content="http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/TreeOfServicesAndCharacteristics_Remote_2x.png">
<meta property="og:updated_time" content="2017-12-27T08:17:21.390Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS蓝牙4.0开发之CoreBluetooth框架">
<meta name="twitter:description" content="这篇文章讲的是苹果原生框架CoreBluetooth的使用。git上有个库BabyBluetooth 基于原生CoreBluetooth框架进行了封装，使用起来也很方便，大家可以尝试一下。  蓝牙常见名称和缩写 MFI ==== make for ipad ,iphone, itouch 专为苹果设备制作的设备  BLE ==== buletouch low energy，蓝牙4.0设备因为低耗电">
<meta name="twitter:image" content="http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/CoreBluetoothFramework.jpeg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/"/>





  <title>iOS蓝牙4.0开发之CoreBluetooth框架 | 兮兮_sunshine</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">兮兮_sunshine</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="SongSong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兮兮_sunshine">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS蓝牙4.0开发之CoreBluetooth框架</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-27T11:56:37+08:00">
                2017-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS开发/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/" class="leancloud_visitors" data-flag-title="iOS蓝牙4.0开发之CoreBluetooth框架">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,790
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这篇文章讲的是苹果原生框架CoreBluetooth的使用。git上有个库<strong><a href="https://github.com/coolnameismy/BabyBluetooth" target="_blank" rel="noopener">BabyBluetooth</a></strong> 基于原生CoreBluetooth框架进行了封装，使用起来也很方便，大家可以尝试一下。 </p>
<h4 id="蓝牙常见名称和缩写"><a href="#蓝牙常见名称和缩写" class="headerlink" title="蓝牙常见名称和缩写"></a>蓝牙常见名称和缩写</h4><ul>
<li><p>MFI ==== make for ipad ,iphone, itouch 专为苹果设备制作的设备</p>
</li>
<li><p>BLE ==== buletouch low energy，蓝牙4.0设备因为低耗电，所以也叫做BLE</p>
</li>
<li><p>peripheral，central == 外设和中心，发起连接的是central，被连接的设备为perilheral</p>
</li>
<li><p>service and characteristic === 服务和特征 </p>
<p>每个设备会提供服务和特征，类似于服务端的api，但是机构不同。每个外设会有很多服务，每个服务中包含很多字段，这些字段的权限一般分为 读read，写write，通知notiy几种，就是我们连接设备后具体需要操作的内容。</p>
</li>
<li><p>Description 每个characteristic可以对应一个或多个Description用户描述characteristic的信息或属性</p>
<a id="more"></a>
</li>
</ul>
<h4 id="蓝牙基础知识"><a href="#蓝牙基础知识" class="headerlink" title="蓝牙基础知识"></a>蓝牙基础知识</h4><blockquote>
<p>CoreBluetooth框架的核心其实是peripheral和central，可以理解成外设和中心，对应他们分别有一组相关的API和类</p>
</blockquote>
<p><img src="/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/CoreBluetoothFramework.jpeg" alt="CoreBluetoothFramework"></p>
<ul>
<li><p>这两组api分别对应不同的业务场景，左侧叫做中心模式，就是以你的app作为中心，连接其他的外设的场景，而右侧称为外设模式，使用手机作为外设识别其他中心设备操作的场景。</p>
</li>
<li><p>服务和特征(service and characteristic) === 每个设备都会有一些服务，每个服务里面都会有一些特征。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//objcetive c特征的定义枚举</span><br><span class="line">  typedef NS_OPTIONS(NSUInteger, CBCharacteristicProperties) &#123;</span><br><span class="line">      CBCharacteristicPropertyBroadcast                          = 0x01,</span><br><span class="line">      CBCharacteristicPropertyRead                               = 0x02,</span><br><span class="line">      CBCharacteristicPropertyWriteWithoutResponse               = 0x04,</span><br><span class="line">      CBCharacteristicPropertyWrite                              = 0x08,</span><br><span class="line">      CBCharacteristicPropertyNotify                             = 0x10,</span><br><span class="line">      CBCharacteristicPropertyIndicate                           = 0x20,</span><br><span class="line">      CBCharacteristicPropertyAuthenticatedSignedWrites          = 0x40,</span><br><span class="line">      CBCharacteristicPropertyExtendedProperties                 = 0x80,</span><br><span class="line">      CBCharacteristicPropertyNotifyEncryptionRequired NS_ENUM_AVAILABLE(NA, 6_0)        = 0x100,</span><br><span class="line">      CBCharacteristicPropertyIndicateEncryptionRequired NS_ENUM_AVAILABLE(NA, 6_0)    = 0x200</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="外设、服务、特征间的关系"><a href="#外设、服务、特征间的关系" class="headerlink" title="外设、服务、特征间的关系"></a>外设、服务、特征间的关系</h5><p><img src="/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/TreeOfServicesAndCharacteristics_Remote_2x.png" alt="TreeOfServicesAndCharacteristics_Remote_2x"></p>
<h5 id="蓝牙中心模式流程"><a href="#蓝牙中心模式流程" class="headerlink" title="蓝牙中心模式流程"></a>蓝牙中心模式流程</h5><ol>
<li><p>建立中心角色</p>
</li>
<li><p>扫描外设（discover）</p>
</li>
<li><p>连接外设(connect)</p>
</li>
<li><p>扫描外设中的服务和特征(discover)</p>
<p>- 4.1 获取外设的services</p>
<p>- 4.2 获取外设的Characteristics,获取Characteristics的值，获取Characteristics的Descriptor和Descriptor的值</p>
</li>
<li><p>与外设做数据交互(explore and interact)</p>
</li>
<li><p>订阅Characteristic的通知</p>
</li>
<li><p>断开连接(disconnect)</p>
</li>
</ol>
<h5 id="蓝牙外设模式流程"><a href="#蓝牙外设模式流程" class="headerlink" title="蓝牙外设模式流程"></a>蓝牙外设模式流程</h5><ol>
<li>启动一个Peripheral管理对象</li>
<li>本地Peripheral设置服务,特性,描述，权限等等</li>
<li>Peripheral发送广告</li>
<li>设置处理订阅、取消订阅、读characteristic、写characteristic的委托方法</li>
</ol>
<h5 id="蓝牙设备状态"><a href="#蓝牙设备状态" class="headerlink" title="蓝牙设备状态"></a>蓝牙设备状态</h5><ol>
<li>待机状态（standby）：设备没有传输和发送数据，并且没有连接到任何设备</li>
<li>广播状态（Advertiser）：周期性广播状态</li>
<li>扫描状态（Scanner）：主动寻找正在广播的设备</li>
<li>发起链接状态（Initiator）：主动向扫描设备发起连接</li>
<li>主设备（Master）：作为主设备连接到其他设备</li>
<li>从设备（Slave）：作为从设备连接到其他设备</li>
</ol>
<h5 id="蓝牙设备的五种工作状态"><a href="#蓝牙设备的五种工作状态" class="headerlink" title="蓝牙设备的五种工作状态"></a>蓝牙设备的五种工作状态</h5><ul>
<li>准备（standby）</li>
<li>广播（advertising）</li>
<li>监听扫描（Scanning）</li>
<li>发起连接（Initiating）</li>
<li>已连接（Connected）</li>
</ul>
<h5 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h5><ul>
<li>GAAT： Generic Attribute Profile , GATT配置文件是一个通用规范，用于在BLE链路上发送和接收被称为“属性”的数据块。目前所有的BLE应用都基于GATT。 蓝牙SIG规定了许多低功耗设备的配置文件。配置文件是设备如何在特定的应用程序中工作的规格说明。注意一个设备可以实现多个配置文件。例如，一个设备可能包括心率监测仪和电量检测。</li>
<li>Characteristic： 一个characteristic包括一个单一变量和0-n个用来描述characteristic变量的descriptor，characteristic可以被认为是一个类型，类似于类。</li>
<li>Descriptor： Descriptor用来描述characteristic变量的属性。例如，一个descriptor可以规定一个可读的描述，或者一个characteristic变量可接受的范围，或者一个characteristic变量特定的测量单位。 Service service是characteristic的集合。例如，你可能有一个叫“Heart Rate Monitor(心率监测仪)”的service，它包括了很多characteristics，如“heart rate measurement(心率测量)”等。你可以在bluetooth.org 找到一个目前支持的基于GATT的配置文件和服务列表。</li>
</ul>
<h4 id="CoreBluetooth的使用"><a href="#CoreBluetooth的使用" class="headerlink" title="CoreBluetooth的使用"></a>CoreBluetooth的使用</h4><p>注意，测试时下面的UUID请替换成自己的蓝牙设备提供的Service和Characteristic的UUID</p>
<p>(大家可以在iPhone上下载LightBlue来查看一些设备的UUID)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 蓝牙设备提供的服务的UUID</span><br><span class="line">#define kCGMServiceTwoUUID @&quot;0000FFF0-0000-1000-8000-00805F9B34FB&quot;</span><br><span class="line">// 蓝牙设备提供的写入特性</span><br><span class="line">#define kCGMCharacteristicOneUUID @&quot;0000FFF1-0000-1000-8000-00805F9B34FB&quot;</span><br><span class="line">// 蓝牙设备提供的notify特性</span><br><span class="line">#define kCGMCharacteristicTwoUUID @&quot;0000FFF2-0000-1000-8000-00805F9B34FB&quot;</span><br></pre></td></tr></table></figure>
<p><strong>那么，先让我们了解下蓝牙交互流程中几个常用的回调。</strong></p>
<ul>
<li><h6 id="中心设备CBCentralManager更新设备蓝牙状态的回调"><a href="#中心设备CBCentralManager更新设备蓝牙状态的回调" class="headerlink" title="中心设备CBCentralManager更新设备蓝牙状态的回调"></a>中心设备CBCentralManager更新设备蓝牙状态的回调</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (void)centralManagerDidUpdateState:(CBCentralManager *)central &#123;</span><br><span class="line">  	switch (central.state) &#123;</span><br><span class="line">      case CBCentralManagerStatePoweredOn:</span><br><span class="line">      &#123;</span><br><span class="line">          // 扫描外围设备</span><br><span class="line">          [self.centeralManager scanForPeripheralsWithServices:nil options:nil];</span><br><span class="line">      &#125;</span><br><span class="line">          break;</span><br><span class="line"></span><br><span class="line">      default:</span><br><span class="line">          NSLog(@&quot;设备蓝牙未开启&quot;);</span><br><span class="line">          break;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h6 id="中心设备已经发现外围设备回调"><a href="#中心设备已经发现外围设备回调" class="headerlink" title="中心设备已经发现外围设备回调"></a>中心设备已经发现外围设备回调</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (void)centralManager:(CBCentralManager *)central didDiscoverPeripheral:(CBPeripheral *)peripheral advertisementData:(NSDictionary&lt;NSString *,id&gt; *)advertisementData RSSI:(NSNumber *)RSSI &#123;</span><br><span class="line">	NSLog(@&quot;advertisementData.kCBAdvDataManufacturerData = %@&quot;, 	advertisementData[@&quot;kCBAdvDataManufacturerData&quot;]);</span><br><span class="line">    _connectPeripheral = peripheral;</span><br><span class="line">//    [self.centeralManager connectPeripheral:peripheral options:nil];</span><br><span class="line"></span><br><span class="line">   	if ([advertisementData[@&quot;kCBAdvDataLocalName&quot;] hasPrefix:@&quot;SN&quot;]) &#123;</span><br><span class="line">        NSLog(@&quot;已搜索到设备&quot;);</span><br><span class="line">        NSLog(@&quot;peripheral.identifier = %@  peripheral.name = %@&quot;, peripheral.identifier, peripheral.name);</span><br><span class="line">        [_delegate getAdvertisementData:advertisementData andPeripheral:peripheral];</span><br><span class="line">        [_peripheralArray addObject:peripheral];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里有几个问题值得注意：</p>
<ol>
<li><p>在ios中蓝牙广播信息中通常会包含以下4种类型的信息。ios的蓝牙通信协议中不接受其他类型的广播信息。因此需要注意的是，如果需要在扫描设备时，通过蓝牙设备的Mac地址来唯一辨别设备，那么需要与蓝牙设备的硬件工程师沟通好：将所需要的Mac地址放到一下几种类型的广播信息中。通常放到kCBAdvDataManufacturerData这个字段中。</p>
<p>kCBAdvDataIsConnectable = 1;</p>
<p>kCBAdvDataLocalName = XXXXXX;</p>
<p>kCBAdvDataManufacturerData = <xxxxxxxx>;</xxxxxxxx></p>
<p>kCBAdvDataTxPowerLevel = 0;</p>
</li>
<li><p>设备的UUID（peripheral.identifier）是由两个设备的mac通过算法得到的，所以不同的手机连接相同的设备，它的UUID都是不同的，无法标识设备。</p>
</li>
</ol>
<ol>
<li>苹果与蓝牙设备连接通信时，使用的并不是苹果蓝牙模块的Mac地址，使用的是苹果随机生成的十六进制码作为手机蓝牙的Mac与外围蓝牙设备进行交互。如果蓝牙设备与手机在一定时间内多次通信，那么使用的是首次连接时随机生成的十六进制码作为Mac地址，超过这个固定的时间段，手机会清空已随机生成的Mac地址，重新生成。也就是说外围设备是不能通过与苹果手机的交互时所获取的蓝牙Mac地址作为手机的唯一标识的。（这是在与写蓝牙设备的固件工程师联调时根据问题的现象推测的。至于苹果蓝牙通讯协议的底层是否确实完全像我所说的这样，希望了解的读者能提供帮助。在此先谢过。）</li>
</ol>
<ul>
<li><h6 id="中心设备设备连接成功回调"><a href="#中心设备设备连接成功回调" class="headerlink" title="中心设备设备连接成功回调"></a>中心设备设备连接成功回调</h6></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (void)centralManager:(CBCentralManager *)central didConnectPeripheral:(CBPeripheral *)peripheral &#123;</span><br><span class="line">    // 设备停止扫描</span><br><span class="line">    [self.centeralManager stopScan];</span><br><span class="line">    peripheral.delegate = self;</span><br><span class="line">    dispatch_after(2, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        // 查找服务</span><br><span class="line">        [_connectPeripheral discoverServices:@[[CBUUID UUIDWithString:kCGMServiceTwoUUID]]];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><h6 id="中心设备设备连接失败回调"><a href="#中心设备设备连接失败回调" class="headerlink" title="中心设备设备连接失败回调"></a>中心设备设备连接失败回调</h6></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)centralManager:(CBCentralManager *)central didFailToConnectPeripheral:(CBPeripheral *)peripheral error:(NSError *)error &#123;</span><br><span class="line">    [_operationDelegate failToConnect];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><h6 id="中心设备设备连接中断回调"><a href="#中心设备设备连接中断回调" class="headerlink" title="中心设备设备连接中断回调"></a>中心设备设备连接中断回调</h6></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (void)centralManager:(CBCentralManager *)central didDisconnectPeripheral:(CBPeripheral *)peripheral error:(NSError *)error &#123;</span><br><span class="line">    NSLog(@&quot;连接断开 %@&quot;, [error localizedDescription]);</span><br><span class="line">    [_operationDelegate disconnected];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><h6 id="外围设备（CBPeripheral）发现服务（service）回调"><a href="#外围设备（CBPeripheral）发现服务（service）回调" class="headerlink" title="外围设备（CBPeripheral）发现服务（service）回调"></a>外围设备（CBPeripheral）发现服务（service）回调</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)peripheral:(CBPeripheral *)peripheral didDiscoverServices:(NSError *)error &#123;</span><br><span class="line">  if (error) &#123;</span><br><span class="line">      // 输出错误信息</span><br><span class="line">      NSLog(@&quot;discoverServices.error============ %@&quot;, [error localizedDescription]);</span><br><span class="line">      return;</span><br><span class="line">  &#125;</span><br><span class="line">  // 遍历设备提供的服务</span><br><span class="line">  for (CBService *service in peripheral.services) &#123;</span><br><span class="line">      NSLog(@&quot;service.UUID = ------------- = %@&quot;, service.UUID.UUIDString);</span><br><span class="line">      // 找到需要的服务，并获取该服务响应的特性</span><br><span class="line">      if([service.UUID isEqual:[CBUUID UUIDWithString:kCGMServiceTwoUUID]]) &#123;</span><br><span class="line">          [service.peripheral discoverCharacteristics:nil forService:service];</span><br><span class="line">          NSLog(@&quot;开始查找cgm的characteristic&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h6 id="外围设备发现特性（characteristic）回调"><a href="#外围设备发现特性（characteristic）回调" class="headerlink" title="外围设备发现特性（characteristic）回调"></a>外围设备发现特性（characteristic）回调</h6></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)peripheral:(CBPeripheral *)peripheral didDiscoverCharacteristicsForService:(CBService *)service error:(NSError *)error &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        // 输出错误信息</span><br><span class="line">        NSLog(@&quot;discoverCharacteristics.error=========== %@&quot;, [error localizedDescription]);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 遍历服务中的所有特性</span><br><span class="line">    for (CBCharacteristic *characteristic in service.characteristics) &#123;</span><br><span class="line">        if ([characteristic.UUID isEqual:[CBUUID UUIDWithString:kCGMCharacteristicOneUUID]]) &#123;</span><br><span class="line">            // 设置读写的特性</span><br><span class="line">            _readAndWriteCharacteristic = characteristic;</span><br><span class="line">        &#125; else if ([characteristic.UUID isEqual:[CBUUID UUIDWithString:kCGMCharacteristicTwoUUID]]) &#123;</span><br><span class="line">            // 设置需要订阅的特性</span><br><span class="line">            _notifyCharacteristic = characteristic;</span><br><span class="line">            [_connectPeripheral setNotifyValue:YES forCharacteristic:_notifyCharacteristic];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><h6 id="外围设备数据更新回调，-可以在此回调方法中读取信息（无论是read的回调，还是notify（订阅）的回调都是此方法）"><a href="#外围设备数据更新回调，-可以在此回调方法中读取信息（无论是read的回调，还是notify（订阅）的回调都是此方法）" class="headerlink" title="外围设备数据更新回调， 可以在此回调方法中读取信息（无论是read的回调，还是notify（订阅）的回调都是此方法）"></a>外围设备数据更新回调， 可以在此回调方法中读取信息（无论是read的回调，还是notify（订阅）的回调都是此方法）</h6></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (void)peripheral:(CBPeripheral *)peripheral didUpdateValueForCharacteristic:(CBCharacteristic *)characteristic error:(NSError *)error &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        // 输出错误信息</span><br><span class="line">        NSLog(@&quot;didupadteValueForCharacteristic error ============ %@&quot;, [error localizedDescription]);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;value ============= %@&quot;, characteristic.value);</span><br><span class="line">    // 解析数据</span><br><span class="line">    NSData *data = characteristic.value;</span><br><span class="line">    // 将NSData转Byte数组</span><br><span class="line">    NSUInteger len = [data length];</span><br><span class="line">    Byte *byteData = (Byte *)malloc(len);</span><br><span class="line">    memcpy(byteData, [data bytes], len);</span><br><span class="line">    NSMutableArray *commandArray = [NSMutableArray arrayWithCapacity:0];</span><br><span class="line">    // Byte数组转字符串</span><br><span class="line">    for (int i = 0; i &lt; len; i++) &#123;</span><br><span class="line">        NSString *str = [NSString stringWithFormat:@&quot;%02x&quot;, byteData[i]];</span><br><span class="line">        [commandArray addObject:str];</span><br><span class="line">        NSLog(@&quot;byteData = %@&quot;, str);</span><br><span class="line">    &#125;</span><br><span class="line">    // 输出数据</span><br><span class="line">    [_operationDelegate dataWithCharacteristic:commandArray]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><h6 id="特性已写入外围设备的回调-如果写入类型为CBCharacteristicWriteWithResponse-回调此方法，如果写入类型为CBCharacteristicWriteWithoutResponse不回调此方法"><a href="#特性已写入外围设备的回调-如果写入类型为CBCharacteristicWriteWithResponse-回调此方法，如果写入类型为CBCharacteristicWriteWithoutResponse不回调此方法" class="headerlink" title="特性已写入外围设备的回调(如果写入类型为CBCharacteristicWriteWithResponse 回调此方法，如果写入类型为CBCharacteristicWriteWithoutResponse不回调此方法)"></a>特性已写入外围设备的回调(如果写入类型为CBCharacteristicWriteWithResponse 回调此方法，如果写入类型为CBCharacteristicWriteWithoutResponse不回调此方法)</h6></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (void)peripheral:(CBPeripheral *)peripheral didWriteValueForCharacteristic:(CBCharacteristic *)characteristic error:(NSError *)error &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        NSLog(@&quot;write.error=======%@&quot;,error.userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    /* When a write occurs, need to set off a re-read of the local CBCharacteristic to update its value */</span><br><span class="line">    // 读数据</span><br><span class="line">    if ([characteristic.UUID isEqual:[CBUUID UUIDWithString:kCGMCharacteristicOneUUID]]) &#123;</span><br><span class="line">        [self readCharacter];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><h6 id="外围设备订阅特征值状态改变成功的回调"><a href="#外围设备订阅特征值状态改变成功的回调" class="headerlink" title="外围设备订阅特征值状态改变成功的回调"></a>外围设备订阅特征值状态改变成功的回调</h6></li>
</ul>
<p>需要注意的是这里是对kCGMCharacteristicOneUUID这个特性进行写入，这里之所以这样操作是因为我的蓝牙设备的蓝牙协议是这样定义的，所以这里不要照抄照搬，要按照你的蓝牙设备的通讯协议来确定，对哪一个特性进行read，对哪个特性进行write，以及对哪个特性进行设置Notify</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)peripheral:(CBPeripheral *)peripheral didUpdateNotificationStateForCharacteristic:(CBCharacteristic *)characteristic error:(NSError *)error &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        NSLog(@&quot;error = %@&quot;, [error localizedDescription]);</span><br><span class="line">    &#125;</span><br><span class="line">    // 对特性kCGMCharacteristicTwoUUID设置notify(订阅)，成功以后回调</span><br><span class="line">    if ([characteristic.UUID.UUIDString isEqualToString:kCGMCharacteristicTwoUUID] &amp;&amp; characteristic.isNotifying) &#123;</span><br><span class="line">        // 写数据 回调-didWriteValueForCharacteristic</span><br><span class="line">        NSLog(@&quot;写数据到cgm设备的characteristic = %@&quot;, _readAndWriteCharacteristic.UUID.UUIDString);</span><br><span class="line">        [_operationDelegate writeCharacteristic];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>另外，除了回调以外，还有几个点需要注意:</strong></p>
<ul>
<li><h6 id="搜索外围设备"><a href="#搜索外围设备" class="headerlink" title="搜索外围设备"></a>搜索外围设备</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)searchlinkDevice &#123;</span><br><span class="line">  // 实现代理</span><br><span class="line">  // 扫描设备</span><br><span class="line">//    _centeralManager = [[CBCentralManager alloc] initWithDelegate:self</span><br><span class="line">//                                                            queue:nil];</span><br><span class="line"></span><br><span class="line">  if(self.centeralManager.state == CBCentralManagerStatePoweredOff) &#123;</span><br><span class="line">      // 蓝牙关闭的</span><br><span class="line">  &#125; else if(self.centeralManager.state == CBCentralManagerStateUnsupported) &#123;</span><br><span class="line">      // 设备不支持蓝牙</span><br><span class="line">  &#125; else if (self.centeralManager.state == CBCentralManagerStatePoweredOn || self.centeralManager.state == CBCentralManagerStateUnknown) &#123;</span><br><span class="line">      // 开启的话开始扫描蓝牙设备</span><br><span class="line">      [self.centeralManager scanForPeripheralsWithServices:nil options:nil];</span><br><span class="line">      double delayInSeconds = 20.0;</span><br><span class="line">      // 扫描20s后未扫描到设备停止扫描</span><br><span class="line">      dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC));</span><br><span class="line">      dispatch_after(popTime, dispatch_get_main_queue(), ^(void) &#123;</span><br><span class="line">          [self stopScan];</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h6 id="对某个特性（characteristic）写入数据"><a href="#对某个特性（characteristic）写入数据" class="headerlink" title="对某个特性（characteristic）写入数据"></a>对某个特性（characteristic）写入数据</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (void)writeCharacter:(NSData *)data &#123;</span><br><span class="line">  NSLog(@&quot; characteristic.uuid = %@ data ==== %@&quot;, _readAndWriteCharacteristic.UUID.UUIDString, data);</span><br><span class="line">  if ([_readAndWriteCharacteristic.UUID isEqual:[CBUUID UUIDWithString:kCGMCharacteristicOneUUID]]) &#123;</span><br><span class="line">      [_connectPeripheral writeValue:data forCharacteristic:_readAndWriteCharacteristic type:CBCharacteristicWriteWithResponse];</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">      [_connectPeripheral writeValue:data</span><br><span class="line">                   forCharacteristic:_readAndWriteCharacteristic</span><br><span class="line">                        type:CBCharacteristicWriteWithoutResponse];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h6 id="读数据"><a href="#读数据" class="headerlink" title="读数据"></a>读数据</h6></li>
</ul>
<p>需要注意的是这里读取蓝牙信息 （但并不是在返回值中接收，要在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)peripheral:(CBPeripheral *)peripheral didUpdateValueForCharacteristic:(CBCharacteristic *)characteristic error:(NSError *)error;</span><br></pre></td></tr></table></figure>
<p>这个回调方法中接收）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)readCharacter &#123;</span><br><span class="line">    [_connectPeripheral readValueForCharacteristic:_readAndWriteCharacteristic];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      
    </div>

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    SongSong
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/" title="iOS蓝牙4.0开发之CoreBluetooth框架">http://www.qfnusjr.com/2017/12/27/iOS蓝牙4-0开发之CoreBluetooth框架/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/蓝牙/" rel="tag"><i class="fa fa-tag"></i> 蓝牙</a>
          
            <a href="/tags/CoreBluetooth/" rel="tag"><i class="fa fa-tag"></i> CoreBluetooth</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/19/scrapy爬虫出现Forbidden-by-robots-txt/" rel="next" title="scrapy爬虫出现Forbidden by robots.txt">
                <i class="fa fa-chevron-left"></i> scrapy爬虫出现Forbidden by robots.txt
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="SongSong" />
            
              <p class="site-author-name" itemprop="name">SongSong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/qfnusjr" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:qfnusjr@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#蓝牙常见名称和缩写"><span class="nav-number">1.</span> <span class="nav-text"><a href="#&#x84DD;&#x7259;&#x5E38;&#x89C1;&#x540D;&#x79F0;&#x548C;&#x7F29;&#x5199;" class="headerlink" title="&#x84DD;&#x7259;&#x5E38;&#x89C1;&#x540D;&#x79F0;&#x548C;&#x7F29;&#x5199;"></a>&#x84DD;&#x7259;&#x5E38;&#x89C1;&#x540D;&#x79F0;&#x548C;&#x7F29;&#x5199;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#蓝牙基础知识"><span class="nav-number">2.</span> <span class="nav-text"><a href="#&#x84DD;&#x7259;&#x57FA;&#x7840;&#x77E5;&#x8BC6;" class="headerlink" title="&#x84DD;&#x7259;&#x57FA;&#x7840;&#x77E5;&#x8BC6;"></a>&#x84DD;&#x7259;&#x57FA;&#x7840;&#x77E5;&#x8BC6;</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#外设、服务、特征间的关系"><span class="nav-number">2.1.</span> <span class="nav-text"><a href="#&#x5916;&#x8BBE;&#x3001;&#x670D;&#x52A1;&#x3001;&#x7279;&#x5F81;&#x95F4;&#x7684;&#x5173;&#x7CFB;" class="headerlink" title="&#x5916;&#x8BBE;&#x3001;&#x670D;&#x52A1;&#x3001;&#x7279;&#x5F81;&#x95F4;&#x7684;&#x5173;&#x7CFB;"></a>&#x5916;&#x8BBE;&#x3001;&#x670D;&#x52A1;&#x3001;&#x7279;&#x5F81;&#x95F4;&#x7684;&#x5173;&#x7CFB;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#蓝牙中心模式流程"><span class="nav-number">2.2.</span> <span class="nav-text"><a href="#&#x84DD;&#x7259;&#x4E2D;&#x5FC3;&#x6A21;&#x5F0F;&#x6D41;&#x7A0B;" class="headerlink" title="&#x84DD;&#x7259;&#x4E2D;&#x5FC3;&#x6A21;&#x5F0F;&#x6D41;&#x7A0B;"></a>&#x84DD;&#x7259;&#x4E2D;&#x5FC3;&#x6A21;&#x5F0F;&#x6D41;&#x7A0B;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#蓝牙外设模式流程"><span class="nav-number">2.3.</span> <span class="nav-text"><a href="#&#x84DD;&#x7259;&#x5916;&#x8BBE;&#x6A21;&#x5F0F;&#x6D41;&#x7A0B;" class="headerlink" title="&#x84DD;&#x7259;&#x5916;&#x8BBE;&#x6A21;&#x5F0F;&#x6D41;&#x7A0B;"></a>&#x84DD;&#x7259;&#x5916;&#x8BBE;&#x6A21;&#x5F0F;&#x6D41;&#x7A0B;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#蓝牙设备状态"><span class="nav-number">2.4.</span> <span class="nav-text"><a href="#&#x84DD;&#x7259;&#x8BBE;&#x5907;&#x72B6;&#x6001;" class="headerlink" title="&#x84DD;&#x7259;&#x8BBE;&#x5907;&#x72B6;&#x6001;"></a>&#x84DD;&#x7259;&#x8BBE;&#x5907;&#x72B6;&#x6001;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#蓝牙设备的五种工作状态"><span class="nav-number">2.5.</span> <span class="nav-text"><a href="#&#x84DD;&#x7259;&#x8BBE;&#x5907;&#x7684;&#x4E94;&#x79CD;&#x5DE5;&#x4F5C;&#x72B6;&#x6001;" class="headerlink" title="&#x84DD;&#x7259;&#x8BBE;&#x5907;&#x7684;&#x4E94;&#x79CD;&#x5DE5;&#x4F5C;&#x72B6;&#x6001;"></a>&#x84DD;&#x7259;&#x8BBE;&#x5907;&#x7684;&#x4E94;&#x79CD;&#x5DE5;&#x4F5C;&#x72B6;&#x6001;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#名词解释"><span class="nav-number">2.6.</span> <span class="nav-text"><a href="#&#x540D;&#x8BCD;&#x89E3;&#x91CA;" class="headerlink" title="&#x540D;&#x8BCD;&#x89E3;&#x91CA;"></a>&#x540D;&#x8BCD;&#x89E3;&#x91CA;</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CoreBluetooth的使用"><span class="nav-number">3.</span> <span class="nav-text"><a href="#CoreBluetooth&#x7684;&#x4F7F;&#x7528;" class="headerlink" title="CoreBluetooth&#x7684;&#x4F7F;&#x7528;"></a>CoreBluetooth&#x7684;&#x4F7F;&#x7528;</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#中心设备CBCentralManager更新设备蓝牙状态的回调"><span class="nav-number">3.0.1.</span> <span class="nav-text"><a href="#&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;CBCentralManager&#x66F4;&#x65B0;&#x8BBE;&#x5907;&#x84DD;&#x7259;&#x72B6;&#x6001;&#x7684;&#x56DE;&#x8C03;" class="headerlink" title="&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;CBCentralManager&#x66F4;&#x65B0;&#x8BBE;&#x5907;&#x84DD;&#x7259;&#x72B6;&#x6001;&#x7684;&#x56DE;&#x8C03;"></a>&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;CBCentralManager&#x66F4;&#x65B0;&#x8BBE;&#x5907;&#x84DD;&#x7259;&#x72B6;&#x6001;&#x7684;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#中心设备已经发现外围设备回调"><span class="nav-number">3.0.2.</span> <span class="nav-text"><a href="#&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0;&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x56DE;&#x8C03;" class="headerlink" title="&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0;&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x56DE;&#x8C03;"></a>&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0;&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#中心设备设备连接成功回调"><span class="nav-number">3.0.3.</span> <span class="nav-text"><a href="#&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x6210;&#x529F;&#x56DE;&#x8C03;" class="headerlink" title="&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x6210;&#x529F;&#x56DE;&#x8C03;"></a>&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x6210;&#x529F;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#中心设备设备连接失败回调"><span class="nav-number">3.0.4.</span> <span class="nav-text"><a href="#&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x5931;&#x8D25;&#x56DE;&#x8C03;" class="headerlink" title="&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x5931;&#x8D25;&#x56DE;&#x8C03;"></a>&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x5931;&#x8D25;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#中心设备设备连接中断回调"><span class="nav-number">3.0.5.</span> <span class="nav-text"><a href="#&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x4E2D;&#x65AD;&#x56DE;&#x8C03;" class="headerlink" title="&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x4E2D;&#x65AD;&#x56DE;&#x8C03;"></a>&#x4E2D;&#x5FC3;&#x8BBE;&#x5907;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x4E2D;&#x65AD;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#外围设备（CBPeripheral）发现服务（service）回调"><span class="nav-number">3.0.6.</span> <span class="nav-text"><a href="#&#x5916;&#x56F4;&#x8BBE;&#x5907;&#xFF08;CBPeripheral&#xFF09;&#x53D1;&#x73B0;&#x670D;&#x52A1;&#xFF08;service&#xFF09;&#x56DE;&#x8C03;" class="headerlink" title="&#x5916;&#x56F4;&#x8BBE;&#x5907;&#xFF08;CBPeripheral&#xFF09;&#x53D1;&#x73B0;&#x670D;&#x52A1;&#xFF08;service&#xFF09;&#x56DE;&#x8C03;"></a>&#x5916;&#x56F4;&#x8BBE;&#x5907;&#xFF08;CBPeripheral&#xFF09;&#x53D1;&#x73B0;&#x670D;&#x52A1;&#xFF08;service&#xFF09;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#外围设备发现特性（characteristic）回调"><span class="nav-number">3.0.7.</span> <span class="nav-text"><a href="#&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x53D1;&#x73B0;&#x7279;&#x6027;&#xFF08;characteristic&#xFF09;&#x56DE;&#x8C03;" class="headerlink" title="&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x53D1;&#x73B0;&#x7279;&#x6027;&#xFF08;characteristic&#xFF09;&#x56DE;&#x8C03;"></a>&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x53D1;&#x73B0;&#x7279;&#x6027;&#xFF08;characteristic&#xFF09;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#外围设备数据更新回调，-可以在此回调方法中读取信息（无论是read的回调，还是notify（订阅）的回调都是此方法）"><span class="nav-number">3.0.8.</span> <span class="nav-text"><a href="#&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x6570;&#x636E;&#x66F4;&#x65B0;&#x56DE;&#x8C03;&#xFF0C;-&#x53EF;&#x4EE5;&#x5728;&#x6B64;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;&#x4E2D;&#x8BFB;&#x53D6;&#x4FE1;&#x606F;&#xFF08;&#x65E0;&#x8BBA;&#x662F;read&#x7684;&#x56DE;&#x8C03;&#xFF0C;&#x8FD8;&#x662F;notify&#xFF08;&#x8BA2;&#x9605;&#xFF09;&#x7684;&#x56DE;&#x8C03;&#x90FD;&#x662F;&#x6B64;&#x65B9;&#x6CD5;&#xFF09;" class="headerlink" title="&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x6570;&#x636E;&#x66F4;&#x65B0;&#x56DE;&#x8C03;&#xFF0C; &#x53EF;&#x4EE5;&#x5728;&#x6B64;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;&#x4E2D;&#x8BFB;&#x53D6;&#x4FE1;&#x606F;&#xFF08;&#x65E0;&#x8BBA;&#x662F;read&#x7684;&#x56DE;&#x8C03;&#xFF0C;&#x8FD8;&#x662F;notify&#xFF08;&#x8BA2;&#x9605;&#xFF09;&#x7684;&#x56DE;&#x8C03;&#x90FD;&#x662F;&#x6B64;&#x65B9;&#x6CD5;&#xFF09;"></a>&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x6570;&#x636E;&#x66F4;&#x65B0;&#x56DE;&#x8C03;&#xFF0C; &#x53EF;&#x4EE5;&#x5728;&#x6B64;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;&#x4E2D;&#x8BFB;&#x53D6;&#x4FE1;&#x606F;&#xFF08;&#x65E0;&#x8BBA;&#x662F;read&#x7684;&#x56DE;&#x8C03;&#xFF0C;&#x8FD8;&#x662F;notify&#xFF08;&#x8BA2;&#x9605;&#xFF09;&#x7684;&#x56DE;&#x8C03;&#x90FD;&#x662F;&#x6B64;&#x65B9;&#x6CD5;&#xFF09;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#特性已写入外围设备的回调-如果写入类型为CBCharacteristicWriteWithResponse-回调此方法，如果写入类型为CBCharacteristicWriteWithoutResponse不回调此方法"><span class="nav-number">3.0.9.</span> <span class="nav-text"><a href="#&#x7279;&#x6027;&#x5DF2;&#x5199;&#x5165;&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x7684;&#x56DE;&#x8C03;-&#x5982;&#x679C;&#x5199;&#x5165;&#x7C7B;&#x578B;&#x4E3A;CBCharacteristicWriteWithResponse-&#x56DE;&#x8C03;&#x6B64;&#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x5199;&#x5165;&#x7C7B;&#x578B;&#x4E3A;CBCharacteristicWriteWithoutResponse&#x4E0D;&#x56DE;&#x8C03;&#x6B64;&#x65B9;&#x6CD5;" class="headerlink" title="&#x7279;&#x6027;&#x5DF2;&#x5199;&#x5165;&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x7684;&#x56DE;&#x8C03;(&#x5982;&#x679C;&#x5199;&#x5165;&#x7C7B;&#x578B;&#x4E3A;CBCharacteristicWriteWithResponse &#x56DE;&#x8C03;&#x6B64;&#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x5199;&#x5165;&#x7C7B;&#x578B;&#x4E3A;CBCharacteristicWriteWithoutResponse&#x4E0D;&#x56DE;&#x8C03;&#x6B64;&#x65B9;&#x6CD5;)"></a>&#x7279;&#x6027;&#x5DF2;&#x5199;&#x5165;&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x7684;&#x56DE;&#x8C03;(&#x5982;&#x679C;&#x5199;&#x5165;&#x7C7B;&#x578B;&#x4E3A;CBCharacteristicWriteWithResponse &#x56DE;&#x8C03;&#x6B64;&#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x5199;&#x5165;&#x7C7B;&#x578B;&#x4E3A;CBCharacteristicWriteWithoutResponse&#x4E0D;&#x56DE;&#x8C03;&#x6B64;&#x65B9;&#x6CD5;)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#外围设备订阅特征值状态改变成功的回调"><span class="nav-number">3.0.10.</span> <span class="nav-text"><a href="#&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x8BA2;&#x9605;&#x7279;&#x5F81;&#x503C;&#x72B6;&#x6001;&#x6539;&#x53D8;&#x6210;&#x529F;&#x7684;&#x56DE;&#x8C03;" class="headerlink" title="&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x8BA2;&#x9605;&#x7279;&#x5F81;&#x503C;&#x72B6;&#x6001;&#x6539;&#x53D8;&#x6210;&#x529F;&#x7684;&#x56DE;&#x8C03;"></a>&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x8BA2;&#x9605;&#x7279;&#x5F81;&#x503C;&#x72B6;&#x6001;&#x6539;&#x53D8;&#x6210;&#x529F;&#x7684;&#x56DE;&#x8C03;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#搜索外围设备"><span class="nav-number">3.0.11.</span> <span class="nav-text"><a href="#&#x641C;&#x7D22;&#x5916;&#x56F4;&#x8BBE;&#x5907;" class="headerlink" title="&#x641C;&#x7D22;&#x5916;&#x56F4;&#x8BBE;&#x5907;"></a>&#x641C;&#x7D22;&#x5916;&#x56F4;&#x8BBE;&#x5907;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#对某个特性（characteristic）写入数据"><span class="nav-number">3.0.12.</span> <span class="nav-text"><a href="#&#x5BF9;&#x67D0;&#x4E2A;&#x7279;&#x6027;&#xFF08;characteristic&#xFF09;&#x5199;&#x5165;&#x6570;&#x636E;" class="headerlink" title="&#x5BF9;&#x67D0;&#x4E2A;&#x7279;&#x6027;&#xFF08;characteristic&#xFF09;&#x5199;&#x5165;&#x6570;&#x636E;"></a>&#x5BF9;&#x67D0;&#x4E2A;&#x7279;&#x6027;&#xFF08;characteristic&#xFF09;&#x5199;&#x5165;&#x6570;&#x636E;</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#读数据"><span class="nav-number">3.0.13.</span> <span class="nav-text"><a href="#&#x8BFB;&#x6570;&#x636E;" class="headerlink" title="&#x8BFB;&#x6570;&#x636E;"></a>&#x8BFB;&#x6570;&#x636E;</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SongSong</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">总字数&#58;</span>
    
    <span title="总字数">5.9k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>

-->



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  





  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_sphere.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname, 
            owner: 'qfnusjr',
            repo: 'qfnusjr.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '9c6b21b6c1add8bf50e6316ce144c4ca31de801b',
            
                client_id: 'b554ff49b3b0ed19806f'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("B1qEkSkBEIUFPXbMUqOXKlyH-gzGzoHsz", "d0bbOl6yUmgiLAnz0jhVPJri");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  


  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/src/love.js"></script>
</body>
</html>
